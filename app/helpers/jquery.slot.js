define(["require","exports","module","util/helper","hgn!template/addThisEvent"],function(e,t){var n=e("util/helper"),r=e("hgn!template/addThisEvent");(function(e){function a(e,t,n){var r,i=[],s=n.get("lessons")[e][t.index];i.push("<b>GROUP: </b>"+t.classNo),i.push("<b>TYPE: </b>"+t.type),i.push("<b>WEEK: </b>"+t.weekType);for(r=0;r<s.length;r++)r===0?i.push("<b>TIME: </b>"+s[r].weekDay.slice(0,3)+" "+s[r].startTime+"-"+s[r].endTime):i.push("<b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b>"+s[r].weekDay.slice(0,3)+" "+s[r].startTime+"-"+s[r].endTime);return i.push("<b>ROOM: </b>"+t.room),i.join("<br>")}function f(e,t){return r({slot:e,module:t.data,time:l(e)})}function l(e){var t=n.getWeekOneDateOfWeekday(e.weekDay),r=parseInt(e.startTime,10),i=parseInt(e.endTime,10),s=new Date(t),o=new Date(t);return s.setHours(r/100),s.setMinutes(r%100),o.setHours(i/100),o.setMinutes(i%100),{startDateTime:n.getDateFormatted(s),endDateTime:n.getDateFormatted(o)}}function c(e,t,n){e==="location"?t.text(n.room):e==="group"?t.text(n.classNo):e==="week"&&t.text(n.weekType)}var t="planner_",i="slot",s=e("#tt-grid"),o=e("#basket-scroll"),u=function(t,n){this.$elem=e(t),this.init(n)};u.prototype={constructor:u,init:function(e){this.$info=this.$elem.find(".opt-info"),this.code=e.code,this.type=e.type,this.slot=e.slot,this.data=e.module,this.id=this.$elem.attr("id"),this.sid=this.id.substr(0,this.id.lastIndexOf("-")),this.updateElem(),this.attachPopover(),this.attachEvents(e.droppable),this.attachDragDrop(e.droppable)},get:function(e){return this.data.get(e)},updateElem:function(){var t=this;this.$elem.data("span")<3&&this.code.length>7&&(this.$elem.addClass("small"),e.subscribe("app:fullsize",function(e,n){n?t.$elem.removeClass("small"):t.$elem.addClass("small")})),planner.slotType!=="location"&&c(planner.slotType,t.$info,t.slot),e.subscribe("app:slotType",function(){c(planner.slotType,t.$info,t.slot),t.$elem.find(".addthisevent-drop").remove()}),e.subscribe("module:calendar",function(){t.$elem.find(".addthisevent-drop").length===0&&t.$elem.find("p").prepend(f(t.slot,t.data))})},attachPopover:function(){function n(e){e?t.$elem.popover({html:!0,trigger:"hover",placement:t.$elem.data("offset")+t.$elem.data("span")>24?"left":"right",title:t.get("code")+" "+t.get("title"),content:a(t.type,t.slot,t.data)}):t.$elem.popover("destroy")}var t=this;n(planner.slotPopover),e.subscribe("app:slotPopover",function(){n(planner.slotPopover)})},attachEvents:function(t){var n=this;if(t)return;this.$elem.on("mouseenter",function(){n.$elem.hasClass("on-dragging")||(s.find(".slot[id^="+n.code+"-]").addClass("hover"),o.find(".module[id="+n.code+"]").addClass("hover"))}),this.$elem.on("mouseleave",function(){s.find(".slot[id^="+n.code+"-]").removeClass("hover"),o.find(".module[id="+n.code+"]").removeClass("hover")}),this.$elem.on("click",function(t){if(e(t.target).hasClass("addthisevent-drop"))return;var r=e("#metro-pivot").data("controller"),i=r.headers.children(".current").text();i==="Modules"?(e.publish("module:detail",n.data),r.goToItemByName("Detail")):e("#detail").data("module")===n.code?r.goToItemByName("Modules"):(e.publish("module:detail",n.data),r.goToItemByName("Detail"))})},attachDragDrop:function(t){var n=this;this.dragOpts={helper:"clone",opacity:.3,cursorAt:{top:20,left:20},revert:"invalid",revertDuration:200,zIndex:1e3,start:e.proxy(n.dragStart,n),stop:e.proxy(n.dragStop,n)},this.dropOpts={activeClass:"highlight",hoverClass:"hover",tolerance:"pointer",over:e.proxy(n.dropOver,n),out:e.proxy(n.dropOut,n),drop:e.proxy(n.dropEvent,n)},t?this.$elem.droppable(this.dropOpts):this.data.count(this.type)>1?this.$elem.draggable(this.dragOpts):this.$elem.addClass("nomove")},dragStart:function(){s.find(".slot[id^="+this.sid+"-]").addClass("on-dragging"),e.publish("grid:module:droppable",[this.slot,this.type,this.data])},dragStop:function(){s.find(".slot[id^="+this.sid+"-]").removeClass("on-dragging"),s.find(".ui-droppable").remove(),e.publish("grid:rows:clearEmpty")},dropEvent:function(t,n){this.$elem.trigger("mouseleave"),n.helper.remove(),s.find(".slot[id^="+this.code+"-"+this.type+"-][data-type="+this.type+"]").remove(),e.publish("grid:module:allocate",[this.slot,this.type,this.data]),setTimeout(function(){e.publish("grid:rows:clearEmpty")},10)},dropOver:function(){s.find(".slot[id^="+this.sid+"-]").addClass("hover"),this.$elem.popover("show")},dropOut:function(){s.find(".slot[id^="+this.sid+"-]").removeClass("hover"),this.$elem.popover("hide")}},e.fn.slot=function(n){return this.each(function(){e.data(this,t+i)||e.data(this,t+i,new u(this,n))})}})(jQuery)});