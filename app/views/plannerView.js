define(["require","exports","module","view/weekdayView","util/helper","util/store"],function(e,t){function o(){var e,t=i.get("grid:occupied");if(t)for(e in t)t.hasOwnProperty(e)&&s[e].addOccupiedSlots(t[e])}function u(e,t,n){var r=e.index,i=n.get("lessons")[t][r];f(i,t,n),n.allocate(t,r)}function a(e){var t,n,i,o,u;t=!0;for(n=0,i=e.length;n<i;n++){o=r.getTimeIndex(e[n].startTime),u=r.getTimeIndex(e[n].endTime)-o;if(s[e[n].weekDay].hasEmptySlots(o,u)!==0){t=!1;break}}return t}function f(e,t,n,r){var i,o;for(i=0,o=e.length;i<o;i++)s[e[i].weekDay].allocate(i,e[i],t,n,r)}var n=e("view/weekdayView"),r=e("util/helper"),i=e("util/store"),s={};t.init=function(){var e,t=planner.weekDays.length;for(e=0;e<t;e++)s[planner.weekDays[e]]=new n(planner.weekDays[e]);o(),$("#tt-grid").on("contextmenu",function(e){e.preventDefault()})},$.subscribe("grid:occupy:allocate",function(e,t,n){s[t].addOccupiedSlots(n)}),$.subscribe("grid:occupy:save",function(e,t){var n=i.get("grid:occupied")||{};n[t]=s[t].getOccupiedSlots(),i.set("grid:occupied",n)}),$.subscribe("grid:module:droppable",function(e,t,n,r){var i=t.index,s=r.get("lessons")[n],o;for(o in s)s.hasOwnProperty(o)&&o!==i&&f(s[o],n,r,!0)}),$.subscribe("grid:refresh",function(){var e,t=planner.weekDays.length;for(e=0;e<t;e++)s[planner.weekDays[e]].compressRows()}),$.subscribe("grid:module:allocate",function(e,t,n,r){u(t,n,r)}),$.subscribe("grid:module:reallocate",function(e,t){var n,r=t.get("lessons"),i;for(n in r)r.hasOwnProperty(n)&&(i=t.allocated(n),i&&u(r[n][i][0],n,t))}),$.subscribe(planner.list.modules+":addOne",function(e,t){if(!t.is("visible"))return;var n,r=t.get("lessons"),i,s,o;for(n in r)if(r.hasOwnProperty(n))if(t.allocated(n))s=r[n][t.allocated(n)],f(s,n,t),t.allocate(n,s[0].index);else{i=!1,s=r[n];for(o in s)if(s.hasOwnProperty(o)&&a(s[o])){f(s[o],n,t),t.allocate(n,o),i=!0;break}i||(o=Object.keys(s)[0],f(s[o],n,t),t.allocate(n,o))}})});